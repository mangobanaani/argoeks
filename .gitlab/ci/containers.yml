# GitLab CI Container building and pushing
# Included in main .gitlab-ci.yml

.container_build_base:
  image: docker:latest
  services:
    - docker:dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_TLS_CERTDIR: "/certs"
    DOCKER_BUILDKIT: 1
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY

.build_and_push_image:
  extends: .container_build_base
  stage: deploy
  script:
    - |
      echo "Building container image: $IMAGE_NAME"

      # Set image tags
      IMAGE_URI="$CI_REGISTRY_IMAGE/$IMAGE_NAME"
      IMAGE_TAG="${CI_COMMIT_SHORT_SHA}"
      IMAGE_LATEST="${IMAGE_URI}:latest"
      IMAGE_VERSION="${IMAGE_URI}:${CI_COMMIT_TAG:-${IMAGE_TAG}}"

      # Build image
      docker build \
        --build-arg BUILD_DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')" \
        --build-arg VCS_REF="$CI_COMMIT_SHA" \
        --build-arg VERSION="$CI_COMMIT_TAG" \
        -t "$IMAGE_LATEST" \
        -t "$IMAGE_VERSION" \
        -f "build/$IMAGE_NAME/Dockerfile" \
        "build/$IMAGE_NAME/"

      # Push images
      docker push "$IMAGE_LATEST"
      docker push "$IMAGE_VERSION"

      # Sign image with cosign if available
      if command -v cosign &> /dev/null; then
        echo "Signing image with Cosign..."
        cosign sign --yes "$IMAGE_VERSION" || true
      fi
  artifacts:
    paths:
      - build/
    expire_in: 1 day

.scan_container_image:
  extends: .container_build_base
  stage: scan
  script:
    - |
      echo "Scanning container image: $IMAGE_NAME"

      IMAGE_URI="$CI_REGISTRY_IMAGE/$IMAGE_NAME"
      IMAGE_VERSION="${IMAGE_URI}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}"

      # Pull image for scanning
      docker pull "$IMAGE_VERSION" || true

      # Run Trivy scan
      docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        aquasec/trivy:latest image \
        --severity HIGH,CRITICAL \
        --format sarif \
        --output trivy-$IMAGE_NAME.sarif \
        "$IMAGE_VERSION" || true
  artifacts:
    reports:
      sast: trivy-*.sarif
    expire_in: 30 days
  allow_failure: true

.sbom_generation:
  extends: .container_build_base
  stage: scan
  script:
    - |
      echo "Generating SBOM for: $IMAGE_NAME"

      IMAGE_URI="$CI_REGISTRY_IMAGE/$IMAGE_NAME"
      IMAGE_VERSION="${IMAGE_URI}:${CI_COMMIT_TAG:-${CI_COMMIT_SHORT_SHA}}"

      # Generate SBOM with Syft
      docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        anchore/syft:latest \
        "$IMAGE_VERSION" \
        -o json \
        > "sbom-$IMAGE_NAME-syft.json" || true

      # Generate SBOM with CycloneDX format
      docker run --rm \
        -v /var/run/docker.sock:/var/run/docker.sock \
        anchore/syft:latest \
        "$IMAGE_VERSION" \
        -o cyclonedx-json \
        > "sbom-$IMAGE_NAME-cyclonedx.json" || true
  artifacts:
    paths:
      - sbom-*.json
    expire_in: 365 days

.harbor_registry_integration:
  extends: .container_build_base
  before_script:
    - |
      # Login to Harbor registry
      docker login -u "$HARBOR_USERNAME" -p "$HARBOR_PASSWORD" "$HARBOR_REGISTRY"
  script:
    - |
      echo "Pushing to Harbor registry..."
      IMAGE_NAME="$IMAGE_NAME"
      HARBOR_IMAGE="$HARBOR_REGISTRY/$HARBOR_PROJECT/$IMAGE_NAME"
      docker tag "$CI_REGISTRY_IMAGE/$IMAGE_NAME:latest" "$HARBOR_IMAGE:latest"
      docker push "$HARBOR_IMAGE:latest"
  allow_failure: true
