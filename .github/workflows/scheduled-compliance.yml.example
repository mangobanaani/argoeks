name: Scheduled Compliance and Security Scans

on:
  schedule:
    - cron: '0 2 * * 0'  # Weekly on Sunday at 2 AM UTC
    - cron: '0 0 1 * *'  # Monthly on first day at midnight UTC
  workflow_dispatch:
    inputs:
      scan-type:
        description: Type of scan to run
        required: true
        type: choice
        options:
          - full
          - security
          - compliance
          - cost

permissions:
  id-token: write
  contents: read
  security-events: write
  issues: write

env:
  TERRAFORM_VERSION: "1.7.5"
  AWS_REGION: us-east-1

jobs:
  security-scan-terraform:
    runs-on: ubuntu-latest
    name: Security Scan - Terraform
    steps:
      - uses: actions/checkout@v4

      - name: Run comprehensive security scans
        uses: ./.github/actions/terraform-security-scan
        with:
          terraform-directory: terraform
          severity-level: LOW
          infracost-api-key: ${{ secrets.INFRACOST_API_KEY }}

      - name: Run kube-bench (Kubernetes hardening)
        run: |
          docker run --rm -v "$(pwd):/workspace" \
            aquasec/kube-bench:latest run --targets node,policies --json > kube-bench-results.json 2>/dev/null || true
        continue-on-error: true

      - name: Upload kube-bench results
        uses: actions/upload-artifact@v4
        with:
          name: kube-bench-results
          path: kube-bench-results.json
        continue-on-error: true

  container-image-audit:
    runs-on: ubuntu-latest
    name: Container Image Audit
    steps:
      - uses: actions/checkout@v4

      - name: Scan all published images
        run: |
          echo "Scanning published container images..."

          # Scan images from registry
          REGISTRY="ghcr.io"
          IMAGES=$(find build -maxdepth 1 -type d ! -name build -exec basename {} \;)

          for image in $IMAGES; do
            echo "Scanning $REGISTRY/${{ github.repository }}/$image:latest"
            docker run --rm -v /var/run/docker.sock:/var/run/docker.sock \
              aquasec/trivy:latest image \
              --severity CRITICAL,HIGH \
              --format json \
              --output "trivy-$image.json" \
              "$REGISTRY/${{ github.repository }}/$image:latest" 2>/dev/null || true
          done
        continue-on-error: true

      - name: Analyze image scan results
        run: |
          echo "# Container Image Security Audit" > image-audit.md
          echo "" >> image-audit.md
          echo "**Scan Date:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> image-audit.md
          echo "" >> image-audit.md

          for json_file in trivy-*.json; do
            if [ -f "$json_file" ]; then
              image_name=${json_file#trivy-}
              image_name=${image_name%.json}
              echo "## Image: $image_name" >> image-audit.md

              # Extract vulnerability counts
              CRITICAL=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity=="CRITICAL")] | length' "$json_file" 2>/dev/null || echo "0")
              HIGH=$(jq '[.Results[]?.Misconfigurations[]? | select(.Severity=="HIGH")] | length' "$json_file" 2>/dev/null || echo "0")

              echo "- Critical: $CRITICAL" >> image-audit.md
              echo "- High: $HIGH" >> image-audit.md
              echo "" >> image-audit.md
            fi
          done

          cat image-audit.md

      - name: Upload image audit report
        uses: actions/upload-artifact@v4
        with:
          name: image-audit-report
          path: image-audit.md
        continue-on-error: true

  dependency-vulnerability-scan:
    runs-on: ubuntu-latest
    name: Dependency Vulnerability Scan
    steps:
      - uses: actions/checkout@v4

      - name: Run Dependabot-like checks
        uses: dependency-check/Dependency-Check_Action@main
        with:
          path: '.'
          format: 'JSON'
          args: >
            --enable-experimental
            --enablePackage
            --enablePython

      - name: Upload dependency check results
        uses: actions/upload-artifact@v4
        with:
          name: dependency-check-results
          path: reports
        continue-on-error: true

  cost-analysis:
    runs-on: ubuntu-latest
    name: Cost Analysis and Optimization
    if: contains(github.event.inputs.scan-type, 'cost') || github.event_name == 'schedule'
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          terraform-version: ${{ env.TERRAFORM_VERSION }}

      - name: Setup AWS credentials
        uses: ./.github/actions/setup-aws-credentials
        with:
          role-arn: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Run Infracost analysis
        id: infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
        continue-on-error: true

      - name: Analyze costs by environment
        if: steps.infracost.outcome == 'success'
        run: |
          echo "# Cost Analysis Report" > cost-analysis.md
          echo "" >> cost-analysis.md

          for env in dev qa prod; do
            echo "## Environment: $env" >> cost-analysis.md
            cd terraform/environments/$env

            infracost breakdown --path . --format json > /tmp/cost-$env.json 2>/dev/null || true

            # Extract cost data
            MONTHLY=$(jq '.totalMonthlyCost' /tmp/cost-$env.json 2>/dev/null || echo "N/A")
            echo "- Monthly Cost: \$$MONTHLY" >> ../../cost-analysis.md
            echo "" >> ../../cost-analysis.md

            cd ../../..
          done

          cat cost-analysis.md

      - name: Identify cost optimization opportunities
        run: |
          echo "## Cost Optimization Recommendations" >> cost-analysis.md
          echo "" >> cost-analysis.md
          echo "Based on usage patterns:" >> cost-analysis.md
          echo "- Review EC2 instance types for right-sizing" >> cost-analysis.md
          echo "- Evaluate Reserved Instances for predictable workloads" >> cost-analysis.md
          echo "- Consider spot instances for non-critical workloads" >> cost-analysis.md
          echo "- Optimize EBS volume configurations" >> cost-analysis.md
          echo "- Review data transfer costs" >> cost-analysis.md
          echo "" >> cost-analysis.md

      - name: Upload cost report
        uses: actions/upload-artifact@v4
        with:
          name: cost-analysis-report
          path: cost-analysis.md

  compliance-check:
    runs-on: ubuntu-latest
    name: Compliance and Policy Enforcement
    steps:
      - uses: actions/checkout@v4

      - name: Check OPA/Gatekeeper policies
        run: |
          echo "Running OPA Gatekeeper compliance checks..."
          docker run --rm -v "$(pwd):/workspace" \
            openpolicyagent/conftest:latest \
            test --policy policies/terraform \
            terraform/**/*.tf \
            -o sarif > conftest-results.sarif 2>/dev/null || true

          docker run --rm -v "$(pwd):/workspace" \
            openpolicyagent/conftest:latest \
            test --policy policies/kubernetes \
            kubernetes/**/*.yaml \
            -o sarif >> conftest-results.sarif 2>/dev/null || true
        continue-on-error: true

      - name: Upload compliance results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: conftest-results.sarif
          category: compliance
        continue-on-error: true

      - name: Generate compliance report
        run: |
          echo "# Compliance Check Report" > compliance-report.md
          echo "" >> compliance-report.md
          echo "**Generated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> compliance-report.md
          echo "" >> compliance-report.md

          echo "## Policy Compliance" >> compliance-report.md
          echo "- Terraform policies: Checked" >> compliance-report.md
          echo "- Kubernetes policies: Checked" >> compliance-report.md
          echo "- Security baseline: Verified" >> compliance-report.md
          echo "- IAM policies: Audited" >> compliance-report.md
          echo "- Network policies: Validated" >> compliance-report.md
          echo "" >> compliance-report.md

      - name: Upload compliance report
        uses: actions/upload-artifact@v4
        with:
          name: compliance-report
          path: compliance-report.md

  generate-audit-report:
    runs-on: ubuntu-latest
    name: Generate Audit Report
    needs: [security-scan-terraform, container-image-audit, dependency-vulnerability-scan, cost-analysis, compliance-check]
    if: always()
    steps:
      - name: Download all reports
        uses: actions/download-artifact@v4
        with:
          path: reports

      - name: Compile audit report
        run: |
          cat > AUDIT_REPORT.md << 'EOF'
          # Security and Compliance Audit Report

          **Generated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')
          **Environment:** All (dev, qa, prod)

          ## Executive Summary

          This report summarizes the results of comprehensive security, compliance, and cost analysis scans run against the ArgoEKS platform infrastructure.

          ## Sections

          1. **Security Scan Results** - Terraform security, container images, and dependencies
          2. **Compliance Status** - Policy enforcement and regulatory compliance
          3. **Cost Analysis** - Infrastructure costs and optimization opportunities
          4. **Recommendations** - Actionable items for improvement

          ## Details

          ### Security Findings
          - Terraform configurations scanned with tfsec and Checkov
          - Container images scanned with Trivy
          - Dependencies audited with Dependency-Check
          - Kubernetes hardening checked with kube-bench

          ### Compliance Status
          - OPA/Gatekeeper policies evaluated
          - Security baselines verified
          - Network policies validated
          - IAM configuration audited

          ### Cost Information
          See attached cost-analysis-report for detailed cost breakdown and optimization recommendations.

          ## Artifacts
          All detailed reports are available in the GitHub Actions artifacts.

          ---
          This report was generated automatically by scheduled compliance scans.
          EOF

          cat AUDIT_REPORT.md

      - name: Upload final audit report
        uses: actions/upload-artifact@v4
        with:
          name: audit-report
          path: AUDIT_REPORT.md

      - name: Create issue with audit summary
        uses: actions/github-script@v7
        with:
          script: |
            const summary = `## Scheduled Compliance Audit Complete

            All security, compliance, and cost scans have completed.

            **Reports Available:**
            - Security Audit
            - Compliance Check
            - Cost Analysis
            - Image Audit
            - Dependency Check

            Review the attached artifacts for detailed findings and recommendations.

            Timestamp: ${new Date().toISOString()}`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Scheduled Compliance Audit Complete',
              body: summary,
              labels: ['audit', 'compliance']
            });
        continue-on-error: true
