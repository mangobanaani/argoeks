name: CI (Lint, Validate, Plan)

on:
  pull_request:
    branches: ["**"]
    types: [opened, synchronize, reopened]

permissions:
  id-token: write
  contents: read

jobs:
  lint-terraform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.7.5 }
      - name: Terraform fmt
        working-directory: terraform
        run: terraform fmt -recursive -check
      - name: TFLint
        uses: terraform-linters/setup-tflint@v4
        with:
          tflint_version: v0.52.0
      - name: Run tflint
        run: |
          tflint --init
          tflint --recursive
      - name: tfsec (Terraform security)
        uses: aquasecurity/tfsec-action@v1.0.7

  lint-k8s:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Kubeconform validate YAML
        uses: docker://ghcr.io/yannh/kubeconform:latest
        with:
          args: >-
            -summary -strict -ignore-missing-schemas
            -kubernetes-version 1.28.0
            gitops/**/*.yaml platform/**/*.yaml || true

  terraform-validate:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        env_name: [dev, qa, prod]
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.7.5 }
      - name: Terraform init (${{ matrix.env_name }})
        run: terraform -chdir=terraform/environments/${{ matrix.env_name }} init -backend=false -input=false
      - name: Terraform validate (${{ matrix.env_name }})
        run: terraform -chdir=terraform/environments/${{ matrix.env_name }} validate -no-color

  cli-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"
      - name: Install dev requirements
        run: pip install -r requirements-dev.txt
      - name: Run CLI unit tests
        run: python -m pytest automation/scripts/tests -v

  policy-checks:
    runs-on: ubuntu-latest
    needs: [lint-terraform]
    steps:
      - uses: actions/checkout@v4
      - name: Conftest (Kubernetes manifests)
        uses: docker://openpolicyagent/conftest:latest
        with:
          args: test --policy policies/kubernetes gitops/**/*.yaml platform/**/*.yaml || true
      - name: Conftest (Terraform plan)
        uses: docker://openpolicyagent/conftest:latest
        with:
          args: test --policy policies/terraform --input terraform plan.json || true

  plan-sandbox:
    runs-on: ubuntu-latest
    needs: [lint-terraform, lint-k8s, terraform-validate, cli-tests]
    env:
      AWS_REGION: us-east-1
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with: { terraform_version: 1.7.5 }
      - name: Package Lambda functions
        run: make package-lambda
      - name: Configure AWS OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
      - name: Terraform init
        working-directory: terraform/environments/sandbox
        run: terraform init -input=false
      - name: Terraform validate
        working-directory: terraform/environments/sandbox
        run: terraform validate -no-color
      - name: Terraform plan (sandbox)
        id: plan
        working-directory: terraform/environments/sandbox
        run: |
          terraform plan -input=false \
            -var="region=${{ env.AWS_REGION }}" \
            -var="cluster_count=1" \
            -var="name_prefix=sbx-pr-${{ github.event.number }}" \
            -out=plan.tfplan
      - name: Upload plan
        uses: actions/upload-artifact@v4
        with:
          name: tfplan-sandbox-pr${{ github.event.number }}
          path: terraform/environments/sandbox/plan.tfplan
