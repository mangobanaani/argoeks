name: Infrastructure Drift Detection

on:
  schedule:
    - cron: '0 */6 * * *'  # Every 6 hours
  workflow_dispatch:
    inputs:
      environment:
        description: Specific environment to check (empty for all)
        required: false
        type: string
      severity:
        description: Minimum drift severity to report
        required: false
        type: choice
        options:
          - critical
          - major
          - minor
        default: minor

permissions:
  id-token: write
  contents: read
  issues: write
  pull-requests: write

env:
  TERRAFORM_VERSION: "1.7.5"
  AWS_REGION: us-east-1

jobs:
  detect-drift:
    runs-on: ubuntu-latest
    name: Detect Drift - ${{ matrix.environment }}
    strategy:
      matrix:
        environment: [dev, qa, prod]
      fail-fast: false
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          terraform-version: ${{ env.TERRAFORM_VERSION }}
          working-directory: terraform/environments/${{ matrix.environment }}

      - name: Setup AWS credentials
        uses: ./.github/actions/setup-aws-credentials
        with:
          role-arn: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Initialize Terraform
        working-directory: terraform/environments/${{ matrix.environment }}
        run: terraform init -input=false

      - name: Refresh state
        id: refresh
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          echo "Refreshing Terraform state..."
          terraform refresh -input=false -no-color > refresh.log 2>&1 || true
          cat refresh.log

      - name: Check for drift
        id: drift
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          echo "Checking for infrastructure drift..."
          terraform plan -input=false -no-color > plan.log 2>&1

          # Check if there are changes
          if grep -q "No changes\|Infrastructure is up-to-date" plan.log; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "drift_summary=No drift detected" >> $GITHUB_OUTPUT
            exit 0
          else
            echo "drift_detected=true" >> $GITHUB_OUTPUT

            # Extract change summary
            SUMMARY=$(grep -E "Plan:|No changes|to be added|to be changed|to be destroyed" plan.log | head -1)
            echo "drift_summary=$SUMMARY" >> $GITHUB_OUTPUT

            # Count changes by type
            ADDS=$(grep -c "^  # .*will be created" plan.log || echo "0")
            CHANGES=$(grep -c "^  # .*will be updated" plan.log || echo "0")
            DELETES=$(grep -c "^  # .*will be destroyed" plan.log || echo "0")

            echo "additions=$ADDS" >> $GITHUB_OUTPUT
            echo "modifications=$CHANGES" >> $GITHUB_OUTPUT
            echo "deletions=$DELETES" >> $GITHUB_OUTPUT

            cat plan.log > drift-details-${{ matrix.environment }}.txt
          fi

      - name: Determine severity
        id: severity
        run: |
          ADDITIONS=${{ steps.drift.outputs.additions || '0' }}
          MODIFICATIONS=${{ steps.drift.outputs.modifications || '0' }}
          DELETIONS=${{ steps.drift.outputs.deletions || '0' }}
          TOTAL=$((ADDITIONS + MODIFICATIONS + DELETIONS))

          if [ "$TOTAL" -gt 10 ]; then
            SEVERITY="critical"
          elif [ "$TOTAL" -gt 5 ]; then
            SEVERITY="major"
          else
            SEVERITY="minor"
          fi

          echo "severity=$SEVERITY" >> $GITHUB_OUTPUT
          echo "total-changes=$TOTAL" >> $GITHUB_OUTPUT

      - name: Create drift issue
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const driftFile = 'terraform/environments/${{ matrix.environment }}/drift-details-${{ matrix.environment }}.txt';

            const issueTitle = `Infrastructure Drift Detected - ${{ matrix.environment }}`;
            const severity = '${{ steps.severity.outputs.severity }}';
            const totalChanges = '${{ steps.severity.outputs.total-changes }}';

            let body = `## Infrastructure Drift Alert

            **Environment:** \`${{ matrix.environment }}\`
            **Severity:** \`${severity}\`
            **Total Changes:** ${totalChanges}

            ### Summary
            - Additions: ${{ steps.drift.outputs.additions || '0' }}
            - Modifications: ${{ steps.drift.outputs.modifications || '0' }}
            - Deletions: ${{ steps.drift.outputs.deletions || '0' }}

            ### Details
            \`\`\`
            ${{ steps.drift.outputs.drift_summary }}
            \`\`\`

            ### Recommended Actions
            1. Review the drift details
            2. Determine if the drift is intentional
            3. Either:
               - Apply the plan to synchronize infrastructure
               - Update Terraform code to match actual state
               - Document the reason for drift

            ### Full Plan Output
            \`\`\`
            `;

            if (fs.existsSync(driftFile)) {
              const details = fs.readFileSync(driftFile, 'utf8');
              body += details.substring(0, 2000);
              body += '\n...(truncated)\n';
            }

            body += '```\n\n**Auto-detected:** ' + new Date().toISOString();

            // Search for existing issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['drift-detection', '${{ matrix.environment }}']
            });

            if (issues.data.length > 0) {
              // Update existing issue
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues.data[0].number,
                body: body
              });
            } else {
              // Create new issue
              github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: body,
                labels: ['drift-detection', '${{ matrix.environment }}', severity]
              });
            }
        continue-on-error: true

      - name: Upload drift report
        if: steps.drift.outputs.drift_detected == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ matrix.environment }}
          path: terraform/environments/${{ matrix.environment }}/drift-details-${{ matrix.environment }}.txt
          retention-days: 30

  reconcile-drift:
    runs-on: ubuntu-latest
    name: Reconcile Critical Drift
    needs: [detect-drift]
    if: failure()
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    strategy:
      matrix:
        environment: [dev, qa]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Terraform
        uses: ./.github/actions/terraform-setup
        with:
          terraform-version: ${{ env.TERRAFORM_VERSION }}
          working-directory: terraform/environments/${{ matrix.environment }}

      - name: Setup AWS credentials
        uses: ./.github/actions/setup-aws-credentials
        with:
          role-arn: ${{ secrets.AWS_IAM_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Auto-reconcile non-prod drift
        if: matrix.environment != 'prod'
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          echo "Reconciling drift for non-production environment..."
          terraform init -input=false
          terraform apply -auto-approve -input=false
        continue-on-error: true

      - name: Create reconciliation PR (prod only)
        if: matrix.environment == 'prod'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Fix: Reconcile infrastructure drift in prod',
              head: 'drift-reconciliation-prod',
              base: 'main',
              body: 'This PR reconciles infrastructure drift detected in production. Review carefully before merging.'
            });
        continue-on-error: true

  generate-drift-report:
    runs-on: ubuntu-latest
    name: Generate Drift Report
    needs: [detect-drift]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Compile drift report
        run: |
          echo "# Infrastructure Drift Report" > drift-report.md
          echo "" >> drift-report.md
          echo "**Generated:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> drift-report.md
          echo "" >> drift-report.md

          for env in dev qa prod; do
            echo "## Environment: $env" >> drift-report.md
            if [ -f "terraform/environments/$env/drift-details-$env.txt" ]; then
              echo '```' >> drift-report.md
              head -50 "terraform/environments/$env/drift-details-$env.txt" >> drift-report.md
              echo '```' >> drift-report.md
            else
              echo "No drift detected" >> drift-report.md
            fi
            echo "" >> drift-report.md
          done

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: drift-report
          path: drift-report.md
          retention-days: 30

      - name: Post to workflow summary
        run: cat drift-report.md >> $GITHUB_STEP_SUMMARY
